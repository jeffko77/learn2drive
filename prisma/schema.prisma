generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Driver {
  id          String    @id @default(cuid())
  name        String
  birthDate   DateTime  @map("birth_date")
  startDate   DateTime  @map("start_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  phases               Phase[]
  quizAttempts         QuizAttempt[]
  drivingLogs          DrivingLog[]
  drivingTestAttempts  DrivingTestAttempt[]
  roadSignTestAttempts RoadSignTestAttempt[]

  @@map("drivers")
}

model DrivingLog {
  id          String   @id @default(cuid())
  driverId    String   @map("driver_id")
  date        DateTime @db.Date
  duration    Int      // duration in minutes
  notes       String?  @db.Text
  weather     String?  // clear, rain, snow, fog, night
  roadTypes   String?  @map("road_types") // residential, highway, city, parking
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driving_logs")
}

model Phase {
  id          String   @id @default(cuid())
  driverId    String   @map("driver_id")
  title       String
  description String?
  orderIndex  Int      @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)
  tasks  Task[]

  @@map("phases")
}

model Task {
  id            String   @id @default(cuid())
  phaseId       String   @map("phase_id")
  title         String
  description   String?
  teachingNotes String?  @map("teaching_notes") @db.Text
  orderIndex    Int      @map("order_index")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  phase    Phase     @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  progress Progress?

  @@map("tasks")
}

model Progress {
  id             String    @id @default(cuid())
  taskId         String    @unique @map("task_id")
  status         String    @default("not_started") // not_started, in_progress, completed
  completionDate DateTime? @map("completion_date")
  notes          String?   @db.Text
  feedback       String?   @db.Text
  updatedAt      DateTime  @updatedAt @map("updated_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("progress")
}

model QuizQuestion {
  id               String   @id @default(cuid())
  topic            String
  questionText     String   @map("question_text") @db.Text
  optionA          String   @map("option_a")
  optionB          String   @map("option_b")
  optionC          String   @map("option_c")
  optionD          String   @map("option_d")
  correctAnswer    String   @map("correct_answer") // A, B, C, or D
  explanation      String?  @db.Text
  chapterReference String?  @map("chapter_reference")
  createdAt        DateTime @default(now()) @map("created_at")

  answers QuizAnswer[]

  @@map("quiz_questions")
}

model QuizAttempt {
  id             String   @id @default(cuid())
  driverId       String   @map("driver_id")
  score          Int
  totalQuestions Int      @map("total_questions")
  dateTaken      DateTime @default(now()) @map("date_taken")
  timeTaken      Int?     @map("time_taken") // in seconds
  mode           String   @default("practice") // practice or test

  driver  Driver       @relation(fields: [driverId], references: [id], onDelete: Cascade)
  answers QuizAnswer[]

  @@map("quiz_attempts")
}

model QuizAnswer {
  id             String  @id @default(cuid())
  attemptId      String  @map("attempt_id")
  questionId     String  @map("question_id")
  selectedAnswer String? @map("selected_answer")
  isCorrect      Boolean @map("is_correct")

  attempt  QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("quiz_answers")
}

// Driving Test Models
model DrivingTestCategory {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  orderIndex  Int      @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")

  criteria DrivingTestCriteria[]

  @@map("driving_test_categories")
}

model DrivingTestCriteria {
  id              String   @id @default(cuid())
  categoryId      String   @map("category_id")
  criteriaName    String   @map("criteria_name")
  evaluationGuide String   @map("evaluation_guide") @db.Text
  maxPoints       Int      @default(5) @map("max_points")
  orderIndex      Int      @map("order_index")
  createdAt       DateTime @default(now()) @map("created_at")

  category    DrivingTestCategory    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  evaluations DrivingTestEvaluation[]

  @@map("driving_test_criteria")
}

model DrivingTestAttempt {
  id               String   @id @default(cuid())
  driverId         String   @map("driver_id")
  testDate         DateTime @default(now()) @map("test_date")
  totalScore       Int?     @map("total_score")
  maxPossibleScore Int?     @map("max_possible_score")
  passed           Boolean?
  evaluatorName    String?  @map("evaluator_name")
  notes            String?  @db.Text
  createdAt        DateTime @default(now()) @map("created_at")

  driver      Driver                  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  evaluations DrivingTestEvaluation[]

  @@map("driving_test_attempts")
}

model DrivingTestEvaluation {
  id              String   @id @default(cuid())
  attemptId       String   @map("attempt_id")
  criteriaId      String   @map("criteria_id")
  pointsDeducted  Int      @default(0) @map("points_deducted")
  evaluatorNotes  String?  @map("evaluator_notes") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  attempt  DrivingTestAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  criteria DrivingTestCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  @@map("driving_test_evaluations")
}

// Road Sign Test Models
model RoadSignCategory {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  orderIndex  Int      @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")

  signs RoadSign[]

  @@map("road_sign_categories")
}

model RoadSign {
  id              String   @id @default(cuid())
  categoryId      String   @map("category_id")
  signName        String   @map("sign_name")
  signMeaning     String   @map("sign_meaning") @db.Text
  shape           String
  colorScheme     String   @map("color_scheme")
  imageUrl        String?  @map("image_url")
  additionalNotes String?  @map("additional_notes") @db.Text
  orderIndex      Int      @map("order_index")
  createdAt       DateTime @default(now()) @map("created_at")

  category RoadSignCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  answers  RoadSignTestAnswer[]

  @@map("road_signs")
}

model RoadSignTestAttempt {
  id             String   @id @default(cuid())
  driverId       String   @map("driver_id")
  testDate       DateTime @default(now()) @map("test_date")
  totalQuestions Int      @map("total_questions")
  correctAnswers Int      @map("correct_answers")
  percentage     Float?
  passed         Boolean?
  timeTaken      Int?     @map("time_taken") // seconds
  testMode       String   @default("all") @map("test_mode") // all, category, timed, practice
  createdAt      DateTime @default(now()) @map("created_at")

  driver  Driver               @relation(fields: [driverId], references: [id], onDelete: Cascade)
  answers RoadSignTestAnswer[]

  @@map("road_sign_test_attempts")
}

model RoadSignTestAnswer {
  id             String   @id @default(cuid())
  attemptId      String   @map("attempt_id")
  signId         String   @map("sign_id")
  selectedAnswer String?  @map("selected_answer")
  isCorrect      Boolean  @map("is_correct")
  timeSpent      Int?     @map("time_spent") // seconds on this question
  createdAt      DateTime @default(now()) @map("created_at")

  attempt RoadSignTestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  sign    RoadSign            @relation(fields: [signId], references: [id], onDelete: Cascade)

  @@map("road_sign_test_answers")
}
